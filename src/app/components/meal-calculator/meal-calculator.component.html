<div class="meal-calculator-container" (click)="closeDropdowns()">
  <header class="header">
    <h2>Plan de comidas de {{ currentProfile }}</h2>
    
    <!-- Selector de tipo de comida -->
    <div class="meal-type-selector">
      <div class="meal-type-buttons">
        <button 
          *ngFor="let mealType of mealTypes" 
          class="meal-type-btn"
          [class.active]="selectedMealType === mealType.key"
          (click)="selectMealType(mealType.key)">
          {{ mealType.label }}
        </button>
      </div>
    </div>
  </header>

  <div class="meal-categories">
    <!-- Skeleton loading -->
    <div class="skeleton-container" *ngIf="isLoading">
      <div class="skeleton-category" *ngFor="let i of [1,2,3,4]">
        <div class="skeleton-header">
          <div class="skeleton-title"></div>
          <div class="skeleton-target"></div>
        </div>
        <div class="skeleton-content">
          <div class="skeleton-item">
            <div class="skeleton-food-info">
              <div class="skeleton-icon"></div>
              <div class="skeleton-name"></div>
            </div>
            <div class="skeleton-amount"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Contenido real -->
    <div 
      class="category-section" 
      *ngFor="let category of getActiveCategories()"
      [class.hidden]="isLoading">
      
      <div class="category-header">
        <h3>{{ category.label }}</h3>
        <span class="category-target">{{ getPortionsText(category.key) }}</span>
      </div>

      <div class="foods-list" *ngIf="mealPlan[category.key] && mealPlan[category.key].length > 0">
        <div 
          class="food-item" 
          *ngFor="let item of mealPlan[category.key]">
          
          <div class="food-item-content">
            <div class="food-info">
              <h4>
                <span class="food-icon">{{ getFoodIcon(item.food.alimento) }}</span>
                {{ item.food.alimento }}
              </h4>
              <div class="food-details">
                <!-- <span class="portion-info">
                  {{ item.portions }} porción{{ item.portions !== 1 ? 'es' : '' }}
                </span> -->
                <span class="portion-info" 
                      [class.clickable-weight]="shouldShowCookedWeight(item.totalAmount) && shouldCategoryShowCookedWeight(category.key)"
                      [class.cooked-mode]="isCookedMode(category.key, item.food) && shouldShowCookedWeight(item.totalAmount) && shouldCategoryShowCookedWeight(category.key)"
                      (click)="(shouldShowCookedWeight(item.totalAmount) && shouldCategoryShowCookedWeight(category.key)) ? toggleCookedWeight(category.key, item.food) : null">
                  {{ getDisplayWeight(category.key, item.food, item.totalAmount) }}
                </span>
              </div>
              
              <!-- Controles de porciones - OCULTOS -->
              <!-- <div class="portion-controls">
                <button 
                  class="portion-btn decrement"
                  (click)="decrementPortions(category.key, item.food)"
                  [disabled]="item.portions <= 1">
                  −
                </button>
                <span class="portion-display">{{ item.portions }}</span>
                <button 
                  class="portion-btn increment"
                  (click)="incrementPortions(category.key, item.food)">
                  +
                </button>
              </div> -->
            </div>
            
            <div class="food-actions">
              <!-- <div class="amount-display">{{ item.totalAmount }}</div> -->
              
              <!-- Botón de cambio que actúa como desplegable -->
              <div class="dropdown-container">
                <button 
                  class="change-btn dropdown-btn"
                  [class.hidden]="showAlternatives !== null"
                  (click)="showAlternatives = showAlternatives === item.food.alimento ? null : item.food.alimento; $event.stopPropagation()">
                  <!-- <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw-icon lucide-refresh-cw">
                    <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                    <path d="M21 3v5h-5"/>
                    <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                    <path d="M8 16H3v5"/>
                  </svg> -->
                  Cambiar
                </button>
                
                <!-- Opciones del desplegable -->
                <div class="dropdown-options" *ngIf="showAlternatives === item.food.alimento" (click)="$event.stopPropagation()">
                  <button 
                    class="dropdown-option"
                    *ngFor="let alternative of getAlternatives(category.key, item.food, selectedMealType)"
                    (click)="replaceFood(category.key, item.food, alternative); showAlternatives = null">
                    <span class="dropdown-icon">{{ getFoodIcon(alternative.alimento) }}</span>
                    <span class="dropdown-content">
                      <span class="dropdown-name">{{ alternative.alimento }}</span>
                      <small class="dropdown-amount">{{ alternative.gramos }}</small>
                    </span>
                  </button>
                </div>
              </div>
            </div>
          </div>
          
        </div>
      </div>

      <div class="no-foods" *ngIf="!mealPlan[category.key] || mealPlan[category.key].length === 0">
        <p>No hay alimentos configurados para esta categoría</p>
        <small>Agrega alimentos en la configuración</small>
      </div>

      <!-- Botón para agregar más alimentos
      <div class="add-food-section" *ngIf="mealPlan[category.key] && mealPlan[category.key].length > 0">
        <button class="add-food-btn" (click)="showAddFood = showAddFood === category.key ? null : category.key">
          ➕ Agregar más alimentos
        </button>
        
        <div class="available-foods" *ngIf="showAddFood === category.key">
          <h5>Alimentos disponibles:</h5>
          <div class="available-foods-list">
            <button 
              class="available-food-btn"
              *ngFor="let food of getAvailableFoods(category.key)"
              (click)="addFoodToPlan(category.key, food)">
              {{ food.alimento }}
              <small>{{ food.gramos }}</small>
            </button>
          </div>
        </div>
      </div> -->
    </div>
  </div>

  <!-- Resumen de ingredientes -->
  <div class="ingredients-summary" [class.hidden]="isLoading">
    <h3>Resumen del {{ getMealTypeLabel() }}</h3>
    <div class="simple-list">
      <div class="ingredient-line" *ngFor="let category of getActiveCategories()">
        <div class="ingredient-item" *ngFor="let item of mealPlan[category.key]">
          <div class="ingredient-info">
            <span class="ingredient-icon">{{ getFoodIcon(item.food.alimento) }}</span>
            <span class="ingredient-name">{{ item.food.alimento }}</span>
          </div>
          <span class="ingredient-amount">{{ getDisplayWeight(category.key, item.food, item.totalAmount) }}</span>
        </div>
      </div>
    </div>
  </div>

</div>
